# MySQL to ClickHouse æ•°æ®è¿ç§»å·¥å…·

ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„MySQLåˆ°ClickHouseæ•°æ®åº“è¿ç§»è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒè‡ªåŠ¨åŒ–å­—æ®µæ˜ å°„ã€è¡¨ç»“æ„è½¬æ¢å’Œæ•°æ®è¿ç§»ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

- ğŸ”„ **è‡ªåŠ¨åŒ–è¿ç§»æµç¨‹**ï¼š6æ­¥å®Œæ•´è¿ç§»å·¥ä½œæµ
- ğŸ¯ **æ™ºèƒ½å­—æ®µæ˜ å°„**ï¼šè‡ªåŠ¨ç”Ÿæˆå¹¶æ”¯æŒè‡ªå®šä¹‰å­—æ®µæ˜ å°„å…³ç³»
- ğŸ“Š **æ•°æ®ç±»å‹è½¬æ¢**ï¼šå®Œæ•´çš„MySQLåˆ°ClickHouseæ•°æ®ç±»å‹æ˜ å°„
- ğŸš€ **æ‰¹é‡å¤„ç†**ï¼šæ”¯æŒå¤§æ•°æ®é‡çš„æ‰¹é‡è¿ç§»
- ğŸ“ **è¯¦ç»†æ—¥å¿—**ï¼šå®Œæ•´çš„æ“ä½œæ—¥å¿—å’Œè¿›åº¦è·Ÿè¸ª
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šå¯é…ç½®çš„æ‰¹å¤„ç†å¤§å°å’Œå¹¶å‘æ§åˆ¶
- ğŸ›¡ï¸ **æ•°æ®éªŒè¯**ï¼šè¿ç§»åæ•°æ®ä¸€è‡´æ€§éªŒè¯
- ğŸ”§ **çµæ´»é…ç½®**ï¼šä¸°å¯Œçš„é…ç½®é€‰é¡¹æ»¡è¶³ä¸åŒéœ€æ±‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
clickhouse_mysql_map-b/
â”œâ”€â”€ README.md                           # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ config.ini.example                  # é…ç½®æ–‡ä»¶æ¨¡æ¿
â”œâ”€â”€ guide.md                            # è¯¦ç»†ä½¿ç”¨æŒ‡å—
â”œâ”€â”€ todo-list.md                        # ä»»åŠ¡æ¸…å•
â”œâ”€â”€ main.py                             # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ 01generate_column_dict_csv.py       # æ­¥éª¤1ï¼šç”Ÿæˆå­—æ®µå­—å…¸
â”œâ”€â”€ 02generate_table_dict_csv.py        # æ­¥éª¤2ï¼šç”Ÿæˆè¡¨å­—å…¸
â”œâ”€â”€ 03column_rename.py                  # æ­¥éª¤3ï¼šå­—æ®µæ˜ å°„å¤„ç†
â”œâ”€â”€ 04table_mapper.py                   # æ­¥éª¤4ï¼šè¡¨æ˜ å°„å¤„ç†
â”œâ”€â”€ column_dict_raw.csv                 # åŸå§‹å­—æ®µå­—å…¸
â”œâ”€â”€ column_dict.csv                     # å¤„ç†åå­—æ®µå­—å…¸ï¼ˆéœ€æ‰‹å·¥ç¼–è¾‘ï¼‰
â”œâ”€â”€ table_dict_raw.csv                  # åŸå§‹è¡¨å­—å…¸
â”œâ”€â”€ table_dict.csv                      # å¤„ç†åè¡¨å­—å…¸ï¼ˆéœ€æ‰‹å·¥ç¼–è¾‘ï¼‰
â”œâ”€â”€ mysql_column_mapper/                # æ­¥éª¤3è¾“å‡ºç›®å½•
â””â”€â”€ logs/                               # æ—¥å¿—æ–‡ä»¶ç›®å½•
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.7+
- MySQL 5.7+ æˆ– 8.0+
- ClickHouse 20.3+

### å®‰è£…ä¾èµ–

```bash
pip install pymysql clickhouse-driver pandas tqdm configparser
```

### é…ç½®è®¾ç½®

1. å¤åˆ¶é…ç½®æ–‡ä»¶æ¨¡æ¿ï¼š
```bash
cp config.ini.example config.ini
```

2. ç¼–è¾‘ `config.ini` æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼š

```ini
[clickhouse]
host = 192.168.10.129
port = 9000
database = abc
user = root
password = 123456

[mysql]
host = 192.168.10.129
port = 9527
database = abc
user = root
password = 123456
charset = utf8mb4

[settings]
# æ‰¹é‡æ’å…¥çš„æ‰¹æ¬¡å¤§å°
batch_size = 100
# æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
verbose = True
# å¦‚æœè¡¨ç»“æ„ä¸åŒ¹é…æ˜¯å¦è‡ªåŠ¨åˆ é™¤é‡å»º
auto_recreate_table = True
# æ˜¯å¦å¯ç”¨æ•°æ®ä¸€è‡´æ€§éªŒè¯
enable_validation = True
# éªŒè¯æ—¶æ£€æŸ¥çš„æ ·æœ¬æ•°æ®è¡Œæ•°
validation_sample_size = 5
# å¦‚æœè¡¨å·²å­˜åœ¨æ˜¯å¦è·³è¿‡å¤„ç†
skip_existing_tables = True
```

## ğŸ“‹ å®Œæ•´è¿ç§»æµç¨‹

### æ­¥éª¤1ï¼šç”Ÿæˆå­—æ®µå­—å…¸

ä»MySQLæ•°æ®åº“æå–æ‰€æœ‰å­—æ®µä¿¡æ¯ï¼Œç”ŸæˆåŸå§‹å­—æ®µå­—å…¸ã€‚

```bash
python 01generate_column_dict_csv.py
```

**è¾“å‡ºæ–‡ä»¶**ï¼š`column_dict_raw.csv`
**æ ¼å¼**ï¼š
```csv
raw_column,remark,new_column
id,ä¸»é”®ID,
name,ç”¨æˆ·å,
create_time,åˆ›å»ºæ—¶é—´,
```

### æ­¥éª¤2ï¼šç”Ÿæˆè¡¨å­—å…¸

ä»MySQLæ•°æ®åº“æå–æ‰€æœ‰è¡¨ä¿¡æ¯ï¼Œç”ŸæˆåŸå§‹è¡¨å­—å…¸ã€‚

```bash
python 02generate_table_dict_csv.py
```

**è¾“å‡ºæ–‡ä»¶**ï¼š`table_dict_raw.csv`
**æ ¼å¼**ï¼š
```csv
table,table_desc
users,ç”¨æˆ·è¡¨
orders,è®¢å•è¡¨
products,äº§å“è¡¨
```

### æ­¥éª¤3ï¼šæ‰‹å·¥ç¼–è¾‘æ˜ å°„å…³ç³»

è¿™æ˜¯**å”¯ä¸€éœ€è¦æ‰‹å·¥å¹²é¢„**çš„æ­¥éª¤ã€‚

1. **ç¼–è¾‘å­—æ®µæ˜ å°„** - ä¿®æ”¹ `column_dict.csv`ï¼š
```csv
raw_column,remark,new_column
id,ä¸»é”®ID,user_id
name,ç”¨æˆ·å,user_name
create_time,åˆ›å»ºæ—¶é—´,created_at
```

2. **ç¼–è¾‘è¡¨æ˜ å°„** - ä¿®æ”¹ `table_dict.csv`ï¼š
```csv
table,table_desc,new_table_name
users,ç”¨æˆ·è¡¨,dim_users
orders,è®¢å•è¡¨,fact_orders
products,äº§å“è¡¨,dim_products
```

### æ­¥éª¤4ï¼šç”Ÿæˆå­—æ®µæ˜ å°„æ–‡ä»¶

æ ¹æ®ç¼–è¾‘å¥½çš„å­—æ®µå­—å…¸ï¼Œä¸ºæ¯ä¸ªè¡¨ç”Ÿæˆå…·ä½“çš„å­—æ®µæ˜ å°„æ–‡ä»¶ã€‚

```bash
python 03column_rename.py
```

**è¾“å‡ºç›®å½•**ï¼š`mysql_column_mapper/`
**è¾“å‡ºæ ¼å¼**ï¼šæ¯ä¸ªè¡¨ä¸€ä¸ªCSVæ–‡ä»¶ï¼ŒåŒ…å«å­—æ®µæ˜ å°„å…³ç³»

### æ­¥éª¤5ï¼šç”Ÿæˆæœ€ç»ˆæ˜ å°„æ–‡ä»¶

å°†å­—æ®µæ˜ å°„æ–‡ä»¶é‡å‘½åä¸ºæœ€ç»ˆæ ¼å¼ï¼Œå‡†å¤‡æ•°æ®è¿ç§»ã€‚

```bash
python 04table_mapper.py
```

**è¾“å‡ºæ ¼å¼**ï¼š`mysql_table_name-clickhouse_table_name.csv`

### æ­¥éª¤6ï¼šæ‰§è¡Œæ•°æ®è¿ç§»

è¿è¡Œä¸»ç¨‹åºï¼Œå¼€å§‹æ•°æ®è¿ç§»è¿‡ç¨‹ã€‚

```bash
python main.py
```

**åŠŸèƒ½**ï¼š
- è‡ªåŠ¨åˆ›å»ºClickHouseè¡¨ç»“æ„
- æ‰¹é‡è¯»å–MySQLæ•°æ®
- æ•°æ®ç±»å‹è½¬æ¢å’Œæ˜ å°„
- å®æ—¶è¿›åº¦æ˜¾ç¤º
- æ•°æ®ä¸€è‡´æ€§éªŒè¯
- è¯¦ç»†çš„è¿ç§»æŠ¥å‘Š

## âš™ï¸ é…ç½®å‚æ•°è¯¦è§£

### ClickHouse é…ç½®
- `host`: ClickHouseæœåŠ¡å™¨åœ°å€
- `port`: ClickHouseæœåŠ¡ç«¯å£ï¼ˆé»˜è®¤9000ï¼‰
- `database`: ç›®æ ‡æ•°æ®åº“å
- `user`: ç”¨æˆ·å
- `password`: å¯†ç 

### MySQL é…ç½®
- `host`: MySQLæœåŠ¡å™¨åœ°å€
- `port`: MySQLæœåŠ¡ç«¯å£ï¼ˆé»˜è®¤3306ï¼‰
- `database`: æºæ•°æ®åº“å
- `user`: ç”¨æˆ·å
- `password`: å¯†ç 
- `charset`: å­—ç¬¦ç¼–ç ï¼ˆå»ºè®®utf8mb4ï¼‰

### è¿ç§»è®¾ç½®
- `batch_size`: æ‰¹å¤„ç†å¤§å°ï¼Œå½±å“å†…å­˜ä½¿ç”¨å’Œæ€§èƒ½
- `verbose`: è¯¦ç»†æ—¥å¿—è¾“å‡º
- `auto_recreate_table`: é‡åˆ°è¡¨ç»“æ„å†²çªæ—¶æ˜¯å¦è‡ªåŠ¨é‡å»º
- `enable_validation`: æ˜¯å¦å¯ç”¨æ•°æ®éªŒè¯
- `validation_sample_size`: éªŒè¯é‡‡æ ·æ•°é‡
- `skip_existing_tables`: æ˜¯å¦è·³è¿‡å·²å­˜åœ¨çš„è¡¨

## ğŸ”„ æ•°æ®ç±»å‹æ˜ å°„

| MySQLç±»å‹ | ClickHouseç±»å‹ | è¯´æ˜ |
|-----------|----------------|------|
| TINYINT | Int8 | 8ä½æ•´æ•° |
| SMALLINT | Int16 | 16ä½æ•´æ•° |
| INT/INTEGER | Int32 | 32ä½æ•´æ•° |
| BIGINT | Int64 | 64ä½æ•´æ•° |
| FLOAT | Float32 | å•ç²¾åº¦æµ®ç‚¹ |
| DOUBLE | Float64 | åŒç²¾åº¦æµ®ç‚¹ |
| DECIMAL | Decimal | ç²¾ç¡®å°æ•° |
| VARCHAR/TEXT | String | å­—ç¬¦ä¸² |
| DATE | Date32 | æ—¥æœŸ |
| DATETIME/TIMESTAMP | DateTime64(6) | æ—¥æœŸæ—¶é—´ |
| TINYINT(1) | Bool | å¸ƒå°”å€¼ |
| JSON | String | JSONå­—ç¬¦ä¸² |

## ğŸ“Š æ—¥å¿—å’Œç›‘æ§

### æ—¥å¿—æ–‡ä»¶ä½ç½®
```
logs/
â”œâ”€â”€ mysql_column_mapper_YYYYMMDD_HHMMSS.log    # å­—æ®µæ˜ å°„æ—¥å¿—
â”œâ”€â”€ clickhouse_file_organizer_YYYYMMDD_HHMMSS.log  # æ–‡ä»¶æ•´ç†æ—¥å¿—
â””â”€â”€ migration_YYYYMMDD_HHMMSS.log               # è¿ç§»è¿‡ç¨‹æ—¥å¿—
```

### ç›‘æ§æŒ‡æ ‡
- å¤„ç†è¡¨æ•°é‡å’Œè¿›åº¦
- æ•°æ®è¡Œæ•°ç»Ÿè®¡
- å¤„ç†æ—¶é—´å’Œæ€§èƒ½
- é”™è¯¯å’Œè­¦å‘Šä¿¡æ¯
- æ•°æ®éªŒè¯ç»“æœ

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: è¿æ¥æ•°æ®åº“å¤±è´¥**
```
A: æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®
   éªŒè¯æ•°æ®åº“æœåŠ¡æ˜¯å¦å¯åŠ¨
   ç¡®è®¤ç”¨æˆ·åå¯†ç æ­£ç¡®
   æ£€æŸ¥æ•°æ®åº“æƒé™è®¾ç½®
```

**Q: å­—æ®µç±»å‹è½¬æ¢å¤±è´¥**
```
A: æ£€æŸ¥æ•°æ®ç±»å‹æ˜ å°„é…ç½®
   éªŒè¯æºæ•°æ®æ˜¯å¦åŒ…å«NULLå€¼
   è°ƒæ•´ClickHouseè¡¨ç»“æ„å®šä¹‰
   æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
```

**Q: è¿ç§»æ€§èƒ½æ…¢**
```
A: è°ƒæ•´batch_sizeå‚æ•°
   ä¼˜åŒ–ç½‘ç»œè¿æ¥
   æ£€æŸ¥ç£ç›˜I/Oæ€§èƒ½
   è€ƒè™‘å¹¶è¡Œå¤„ç†
```

**Q: æ•°æ®éªŒè¯å¤±è´¥**
```
A: æ£€æŸ¥å­—æ®µæ˜ å°„æ˜¯å¦æ­£ç¡®
   éªŒè¯æ•°æ®ç±»å‹è½¬æ¢
   æ’æŸ¥ç‰¹æ®Šå­—ç¬¦é—®é¢˜
   å¢åŠ validation_sample_size
```

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—è¿›è¡Œè°ƒè¯•ï¼š
```ini
[settings]
verbose = True
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ‰¹å¤„ç†å¤§å°**ï¼šæ ¹æ®å¯ç”¨å†…å­˜è°ƒæ•´batch_size
2. **ç½‘ç»œä¼˜åŒ–**ï¼šä½¿ç”¨é«˜é€Ÿç½‘ç»œè¿æ¥
3. **å¹¶è¡Œå¤„ç†**ï¼šå¯¹äºå¤§å‹æ•°æ®åº“ï¼Œè€ƒè™‘åˆ†è¡¨å¹¶è¡Œè¿ç§»
4. **ç´¢å¼•ç­–ç•¥**ï¼šè¿ç§»å®Œæˆåæ·»åŠ é€‚å½“çš„ç´¢å¼•
5. **å‹ç¼©è®¾ç½®**ï¼šé…ç½®ClickHouseå‹ç¼©ç®—æ³•

## ğŸ“š ç¤ºä¾‹

### å®Œæ•´è¿ç§»ç¤ºä¾‹

```bash
# 1. é…ç½®æ•°æ®åº“è¿æ¥
cp config.ini.example config.ini
vim config.ini

# 2. ç”Ÿæˆå­—æ®µå’Œè¡¨å­—å…¸
python 01generate_column_dict_csv.py
python 02generate_table_dict_csv.py

# 3. æ‰‹å·¥ç¼–è¾‘æ˜ å°„å…³ç³»
vim column_dict.csv
vim table_dict.csv

# 4. ç”Ÿæˆæ˜ å°„æ–‡ä»¶
python 03column_rename.py
python 04table_mapper.py

# 5. æ‰§è¡Œè¿ç§»
python main.py
```

### æ‰¹å¤„ç†è„šæœ¬ç¤ºä¾‹

```bash
#!/bin/bash
# auto_migrate.sh

echo "å¼€å§‹MySQLåˆ°ClickHouseè¿ç§»..."

# æ£€æŸ¥é…ç½®æ–‡ä»¶
if [ ! -f "config.ini" ]; then
    echo "é”™è¯¯ï¼šconfig.iniæ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi

# æ‰§è¡Œè¿ç§»æ­¥éª¤
python 01generate_column_dict_csv.py && \
python 02generate_table_dict_csv.py && \
echo "è¯·ç¼–è¾‘column_dict.csvå’Œtable_dict.csvæ–‡ä»¶ï¼Œç„¶åæŒ‰Enterç»§ç»­..." && \
read && \
python 03column_rename.py && \
python 04table_mapper.py && \
python main.py

echo "è¿ç§»å®Œæˆï¼"
```

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚

## ï¿½ï¿½ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ã€‚